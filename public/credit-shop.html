<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="/img/icon.png"/>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- ì•„ì„í¬íŠ¸ ì—°ë™-->
    <script src="https://cdn.iamport.kr/v1/iamport.js"></script>
    <!-- jQuery ì¶”ê°€ -->
    <script type="text/javascript" src="https://code.jquery.com/jquery-1.12.4.min.js" ></script>
    <!--íŒŒë² ë¼ì´ë¸ŒëŸ¬ë¦¬ë¶ˆëŸ¬ì˜¤ê¸°-->
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>
    <title>ê²°ì œì°½</title>
    <!-- ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ -->
    <style>
        :root {
            /*--pc: #4ade80;*/
            --pc: #41c66a;
        }

        ::selection {
            background: var(--pc);
            color: #ffffff;
        }

        body {
            height: 1600px;
            overflow-x: hidden;
            font-family: 'Apple SD Gothic Neo', 'Noto Sans KR', sans-serif;
            /*background-color: #1c1d1f;*/
            background-color: #000;
        }

        img {
            width: 100%;
            height: auto;
            display: block;
        }

        .container {
            max-width: 1280px;
            height: 1500px;
            width: 100%;
            margin: 0 auto;
            position: relative;
            padding-top: 128px;
        }

        h1 {
            font-size: 4.5rem;
            font-weight: 900;
            /*color: var(--pc);*/
            color: #8ffda4;;
            padding-bottom: 10px;
            margin-bottom: 0;
        }

        .user-info {
            border-radius: 8px;
            display: inline-block;
            color: #fff;
            padding-bottom: 164px;
            font-size: 30px;
        }

        .user-id {
            font-weight: bold;
        }

        .credit-options {
            position: relative;
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 55px 30px;
            padding: 0 100px;
        }

        .credit-option {
            padding: 50px;
            /*background-color: #fff;*/
            /*background-color: #f0f4ff;*/
            /*background-color: #f7f7f7;*/
            border-radius: 75px;
            transition: transform 0.5s, box-shadow 0.2s;
            cursor: pointer;
            /*outline: 3px solid #000;*/
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 15px;
            position: relative;
            /*overflow: hidden;*/
        }

        /*.credit-option::before {*/
        /*    content: '-10%';*/
        /*    position: absolute;*/
        /*    width: 100px;*/
        /*    height: 50px;*/
        /*    top: 5px;*/
        /*    left: 10px;*/
        /*    background: red;*/
        /*    border-radius: 20px;*/
        /*    display: flex;*/
        /*    justify-content: center;*/
        /*    align-items: center;*/
        /*    font-size: 15px;*/
        /*    font-weight: bold;*/
        /*    color: #000;*/
        /*}*/

        /*.credit-option::after {*/
        /*    content: '';*/
        /*    position: absolute;*/
        /*    width: 450px;*/
        /*    height: 300px;*/
        /*    bottom: -115px;*/
        /*    left: -50px;*/
        /*    border-radius: 100%;*/
        /*    background: #4e5059;*/
        /*    opacity: 0.1;*/
        /*}*/

        @keyframes gray {
            0% {
                transform: translateY(-6%);
                filter: grayscale(60%);
            }

            20% {
                filter: grayscale(0%);
            }

            50% {
                filter: grayscale(100%);
            }

            100% {
                transform: translateY(0%);
                filter: grayscale(0%);
            }
        }

        @keyframes jumping {
            0% {
                transform: translateY(5%);
                filter: brightness(102%);
            }

            100% {
                transform: translateY(0%);
            }
        }

        @keyframes coin {
            0% {
                opacity: 0;
                transform: translateY(-60%);
                filter: brightness(100%);
            }

            50% {
                opacity: 1;
                transform: translateY(0%);
            }

            80% {
                opacity: 0;
                transform: translateY(60%);
            }

            100% {
                opacity: 0;
            }
        }

        @keyframes coins {
            0% {
                opacity: 0;
                transform: translateY(-60%);
            }

            30% {
                opacity: 1;
                transform: translateY(0%);
            }

            60% {
                opacity: 0;
            }

            70% {
                transform: translateY(60%);
            }

            100% {
                opacity: 0;
            }
        }

        .credit-option:hover,
        .credit-option.selected {
            outline: 4px solid #24974f;
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(255, 255, 255, 0.7);
        }

        .credit-option:hover .img_wrap,
        .credit-option.selected .img_wrap {
            animation: jumping 0.5s ease-in-out infinite alternate;
        }

        /*.credit-option:hover .img_wrap img,*/
        /*.credit-option.selected .img_wrap img {*/
        /*    transition: transform 0.5s;*/
        /*    transform: scale(135%);*/
        /*}*/

        .img_wrap {
            width: 160px;
            padding-bottom: 50px;
        }



        @keyframes bangbang {
            0%   { transform: rotateY(0deg); }
            100% { transform: rotateY(360deg); }
        }

        .credit-option:nth-of-type(1):hover .img_wrap {
            animation: bangbang 3s linear infinite;
        }

        .credit-option:nth-of-type(6) .img_wrap {
            position: relative;
        }

        .credit-option:nth-of-type(6) .img_wrap>img:nth-child(1),
        .img_wrap>img:nth-child(3) {
            position: absolute;
            left: -35px;
        }

        .credit-option:nth-of-type(6) .img_wrap>img:nth-child(3) {
            position: absolute;
            left: 48px;
            bottom: 0;
        }

        .credit-option:nth-of-type(6):hover .img_wrap>img:nth-child(1),
        .credit-option:nth-of-type(6).selected .img_wrap>img:nth-child(1) {
            animation: coin 2s ease-in-out infinite;
        }

        .credit-option:nth-of-type(6):hover .img_wrap>img:nth-child(3),
        .credit-option:nth-of-type(6).selected .img_wrap>img:nth-child(3) {
            animation: coin 2s ease-in-out infinite;
        }

        .credit-amount {
            font-size: 35px;
            font-weight: bold;
            color: #121212;
            color: #fff;
            position: relative;
            display: flex;
            justify-content: center;
        }

        .credit-amount::before {
            content: '';
            position: absolute;
            width: 150px;
            height: 10px;
            top: -35px;
            border-radius: 90%;
            background: radial-gradient(circle, rgba(0,0,0,0.08) 0%, rgba(0,0,0,0) 100%);
        }

        .purchase-button {
            width: 100%;
            padding: 15px 25px;
            border: none;
            border-radius: 50px;
            background-color: #229e49;
            color: white;
            font-size: 18px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.4s;
        }

        .purchase-button:hover {
            /*background: linear-gradient(90deg, rgb(76 166 194 / 59%), #41c66a);*/
            background-color: #176a36;
        }

        .purchase-button:disabled {
            background-color: #cccccc;
            cursor: not-allowed;
        }

        .most-popular {
            position: relative;
        }

        .most-popular::after {
            position: absolute;
            content: 'best!';
            width: 100px;
            height: 50px;
            background: #00c471;
            border-radius: 20px;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 25px;
            font-weight: bold;
            color: #121212;
            top: -20px;
        }

        .credit-options .background {
            height: 1200px;
            width: 3092px;
            right: -5.666vw;
            /*background: linear-gradient(90deg, #000 7.62%, rgb(76 166 194 / 59%) 1280px, #41c66a);*/
            background: linear-gradient(90deg, #000 59% 1280px, #111827);
            position: absolute;
            top: -112px;
            z-index: -1;
            border-radius: 0 256px 64px 0;
        }

        /*ì„ì‹œ!! ì§€ìš¸ê²ƒ.*/
        #header {
            background: #000;
        }

        #header>.inner {
            height: 80px;
        }

        .logo {
            font-size: 1.5rem;
            line-height: 2rem;
            color: #fff;
            font-weight: 900;
            position: relative;
            left: 400px;
        }

        .modal.hidden {
            display: none;
        }

        .modal {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: white;
            border: 1px solid #ccc;
            border-radius: 8px;
            padding: 70px 50px;
            z-index: 1;
        }

        .modal .font-wrap {
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .modal .font-wrap > div:nth-of-type(1) {
            font-size: 32px;
            font-weight: 700;
            padding: 30px;
        }

        .modal .font-wrap > div {
            font-size: 25px;
            font-weight: 500;
        }

        .modal button {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
        }

        .modal .xbtn {
            position: absolute;
            width: 20px;
            height: 20px;
            right: 30px;
        }

        .modal .xbtn::before,
        .modal .xbtn::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 2px;
            height: 24px;
            background-color: #333;
            transform-origin: center;
        }

        .modal .xbtn::before {
            transform: translate(-50%, -50%) rotate(45deg);
        }

        .modal .xbtn::after {
            transform: translate(-50%, -50%) rotate(-45deg);
        }

        .modal .pg_btns {
            display: grid;
            grid-template-columns: 1fr 1fr; /* 2ì¹¸ */
            grid-template-rows: 1fr 1fr;    /* 2ì¤„ */
            gap: 30px;
            align-items: center;
            padding-top: 40px;
            justify-items: center;
        }

        .modal .pg_btns > button {
            width: 150px;
            font-size: 18px;
        }
    </style>
</head>

<body>
<!-- ê¸°ì¡´ HTML êµ¬ì¡° ê·¸ëŒ€ë¡œ ìœ ì§€ -->
<header id="header">
    <div class="inner">
        <h1 class="logo">BangtalBoyBand</h1>
    </div>
</header>
<div class="container">
    <h1>í¬ë ˆë”§ ìƒì </h1>
    <div class="user-info">
        í™˜ì˜í•©ë‹ˆë‹¤! <span id="user-id" class="user-id">ë¡œë”©ì¤‘...</span>ë‹˜!
    </div>
    <div id="pg-modal" class="modal hidden">
        <button class="xbtn" onclick="document.getElementById('pg-modal').classList.add('hidden')"></button>
        <div class="font-wrap">
            <div class="pay-product"></div>
            <div class="pay-amount"></div>
            <div>ê²°ì œ ìˆ˜ë‹¨ì„ ì„ íƒí•˜ì„¸ìš”</div>
        </div>
        <div class="pg_btns">
            <button onclick="handlePGSelect('kakaopay')">
                <img src="./img/kakaopay.svg">
            </button>
            <button onclick="handlePGSelect('tosspay')">
                <img src="./img/tosspay.png">
            </button>
            <button onclick="handlePGSelect('payco')">
                <img src="./img/payco.jpg">
            </button>
            <button onclick="handlePGSelect('nice_v2')">ê·¸ ì™¸</button>
        </div>
    </div>
    <div class="credit-options">
        <div class="credit-option" data-credit="100" data-price="1000">
            <div class="img_wrap">
                <img src="./img/key1.png" alt="ì—´ì‡ 1">
            </div>
            <div class="credit-amount">100 í¬ë ˆë”§</div>
            <button class="purchase-button" onclick="ButtonClick(event)">â‚© 1,000</button>
        </div>
        <div class="credit-option" data-credit="300" data-price="2700">
            <div class="img_wrap">
                <img src="/img/key2.png">
            </div>
            <div class="credit-amount">300 í¬ë ˆë”§</div>
            <button class="purchase-button" onclick="ButtonClick(event)">â‚© 2,700</button>
        </div>
        <div class="credit-option most-popular" data-credit="500" data-price="4000">
            <div class="img_wrap">
                <img src="/img/key3.png">
            </div>
            <div class="credit-amount">500 í¬ë ˆë”§</div>
            <button class="purchase-button" onclick="ButtonClick(event)">â‚© 4,000</button>
        </div>
        <div class="credit-option" data-credit="1000" data-price="7500">
            <div class="img_wrap">
                <img src="/img/key4.png">
            </div>
            <div class="credit-amount">1,000 í¬ë ˆë”§</div>
            <button class="purchase-button" onclick="ButtonClick(event)">â‚© 7,500</button>
        </div>
        <div class="credit-option" data-credit="2000" data-price="14000">
            <div class="img_wrap">
                <img src="/img/key5.png">
            </div>
            <div class="credit-amount">2,000 í¬ë ˆë”§</div>
            <button class="purchase-button" onclick="ButtonClick(event)">â‚© 14,000</button>
        </div>
        <div class="credit-option" data-credit="5000" data-price="30000">
            <div class="img_wrap">
                <img src="/img/calenderCoin3d.png" alt="ì´ë¯¸ì§€">
                <img src="/img/key5.png" alt="ì—´ì‡ ìƒì">
                <img src="/img/calenderCoins3d.png" alt="ì´ë¯¸ì§€">
            </div>
            <div class="credit-amount">5,000 í¬ë ˆë”§</div>
            <button class="purchase-button" onclick="ButtonClick(event)">â‚© 30,000</button>
        </div>
        <div class="background" data-aos="fade-up-left" data-aos-duration="600" data-aos-anchor=".main_buisness"
             data-aos-anchor-placement="top"></div>
    </div>
</div>

<script>
    // Firebase ì´ˆê¸°í™”
    let db = null;
    let firebaseInitialized = false;
    let selectedPG = null; // ì„ íƒëœ ê²°ì œ ìˆ˜ë‹¨ (pgì‚¬)

    async function initializeFirebase() {
        try {
            console.log('ğŸ”¥ Firebase ì´ˆê¸°í™” ì‹œì‘...');

            // server.jsì˜ /firebase-configì™€ ì—°ê²°ë˜ëŠ” ë¼ìš°í„°. ì‘ë‹µ ìƒíƒœ í™•ì¸
            const response = await fetch('/firebase-config');
            if (!response.ok) return console.warn(`âš ï¸ Firebase config ì‘ë‹µ ì˜¤ë¥˜: ${response.status}`);

            // Content-Type í™•ì¸
            const contentType = response.headers.get('content-type');
            if (!contentType || !contentType.includes('application/json')) return console.warn('âš ï¸ Firebase configê°€ JSONì´ ì•„ë‹˜:', contentType);

            // ìœ íš¨í•œ ì„¤ì •ì¸ì§€ í™•ì¸
            const firebaseConfig = await response.json();
            if (!firebaseConfig.apiKey) return console.warn('âš ï¸ Firebase ì„¤ì •ì´ ë”ë¯¸ ê°’ì…ë‹ˆë‹¤.');

            // Firebase ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ì œëŒ€ë¡œ ë¶ˆëŸ¬ì™€ì¡ŒëŠ”ì§€ í™•ì¸
            // firebaseëŠ” ì™¸ë¶€ì—ì„œ ê°€ì ¸ì˜¤ëŠ” ë³€ìˆ˜ëª….
            if (typeof firebase !== 'undefined' && firebaseConfig.apiKey) {
                firebase.initializeApp(firebaseConfig);
                db = firebase.firestore();
                firebaseInitialized = true;
                console.log('âœ… Firebase í´ë¼ì´ì–¸íŠ¸ ì´ˆê¸°í™” ì„±ê³µ');
            } else console.warn('âš ï¸ Firebase SDKë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŒ');
        } catch (error) {
            console.error('âŒ Firebase ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            firebaseInitialized = false;
        }
    }

    // ì•„ì„í¬íŠ¸ ê°ì²´ ì´ˆê¸°í™” (ì¤‘ë³µ ì„ ì–¸ X)
    IMP = window.IMP;
    IMP.init("imp55547674");  // ì•„ì„í¬íŠ¸ ê³ ê°ì‚¬ ì‹ë³„ì½”ë“œ
    let selectedOption = null;

    let currentUserEmail = '';
    let currentUserName = '';

    window.addEventListener('DOMContentLoaded', async () => {
        // Firebase ì´ˆê¸°í™”
        await initializeFirebase();

        const uid = sessionStorage.getItem('userUid'); // ì„œë²„ì—ì„œ ì „ë‹¬í•œ UID
        const selectedCredit = sessionStorage.getItem('selectedCredit');

        console.log('í¬ìƒµ ìœ ì•„ì´ë”” ê°’:', uid);
        console.log('ì„ íƒëœ í¬ë ˆë”§:', selectedCredit);

        if (!uid) return window.location.href = '/login';

        // Firebaseê°€ ì´ˆê¸°í™”ëœ ê²½ìš°ì—ë§Œ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ
        if (firebaseInitialized && db) {
            try {
                const snapshot = await db.collection('Users').where('UserId','==',uid).get();

                if (!snapshot.empty) {
                    const userData = snapshot.docs[0].data();

                    currentUserEmail = userData.Email;
                    currentUserName = userData.Username;
                    document.getElementById('user-id').textContent = currentUserName;

                    console.log('âœ… ì‚¬ìš©ì ì´ë¦„:', currentUserName);
                    console.log('âœ… ì‚¬ìš©ì ì´ë©”ì¼:', currentUserEmail);
                } else window.location.href = '/login';
            } catch (error) {
                console.error('âŒ ì‚¬ìš©ì ì •ë³´ ì¡°íšŒ ì‹¤íŒ¨:', error);
                console.error('âŒ ì—ëŸ¬ ì½”ë“œ:', error.code);
                console.error('âŒ ì—ëŸ¬ ë©”ì‹œì§€:', error.message);
            }
        } else alert('Firebase ë¹„í™œì„±í™”ë¨. í¬ìƒµì´');

        // íŠ¹ì • í¬ë ˆë”§ì´ ì„ íƒëœ ê²½ìš° ìë™ìœ¼ë¡œ í•´ë‹¹ ì˜µì…˜ ì„ íƒ ë° ê²°ì œ ì§„í–‰
        if (selectedCredit && selectedCredit !== 'null') {
            const targetOption = document.querySelector(`[data-credit="${selectedCredit}"]`);
            if (targetOption) {
                // ì˜µì…˜ ì„ íƒ
                document.querySelectorAll('.credit-option').forEach(opt => opt.classList.remove('selected'));
                targetOption.classList.add('selected');
                selectedOption = targetOption;

                // ìƒí’ˆ ì •ë³´ í‘œì‹œ
                const productName = targetOption.querySelector('.credit-amount').textContent;
                const price = targetOption.getAttribute('data-price');
                document.querySelector('.pay-product').textContent = `${productName}`;
                document.querySelector('.pay-amount').textContent = `${Number(price).toLocaleString()}ì›`;

                // ì ê¹ ëŒ€ê¸° í›„ ìë™ìœ¼ë¡œ ê²°ì œ ì§„í–‰
                document.getElementById('pg-modal').classList.remove('hidden');


                // console.log(`${selectedCredit} í¬ë ˆë”§ ìë™ ê²°ì œ ì‹œì‘`);
                // requestpay();
            }
            // sessionStorageì—ì„œ selectedCredit ì œê±° (í•œ ë²ˆë§Œ ì‚¬ìš©)
            sessionStorage.removeItem('selectedCredit');
        }
    });

    // sendToServer í•¨ìˆ˜ë¥¼ ì „ì—­ìœ¼ë¡œ ë¨¼ì € ì •ì˜
    function sendToServer(rsp) {
        console.log('ì„œë²„ë¡œ ì „ì†¡í•  ê²°ì œ ì •ë³´:', rsp);

        // ê²°ì œ ë°ì´í„° ì¤€ë¹„
        const paymentData = {
            orderId: rsp.merchant_uid,
            amount: selectedOption.getAttribute('data-price'),
            orderName: selectedOption.querySelector('.credit-amount').textContent,
            method: rsp.pay_method || 'ì¹´ë“œ',
            paymentKey: rsp.imp_uid,
            creditAmount: selectedOption.getAttribute('data-credit')
        };

        // ì‚¬ìš©ì ë‹‰ë„¤ì„ ê°€ì ¸ì˜¤ê¸°
        const nickname = encodeURIComponent(document.getElementById('user-id').textContent);
        console.log("ì´ê¸° ë­”ë° ", nickname);

        // ğŸ”¥ íŒŒì´ì–´ë² ì´ìŠ¤ì— ê²°ì œ ì •ë³´ ì €ì¥
        savePaymentToFirebase(paymentData, nickname);

        // GET ë°©ì‹ìœ¼ë¡œ Query Parameter ìƒì„±
        const queryParams = new URLSearchParams(paymentData);
        const url = `/verify-user-and-payment?${queryParams.toString()}`;

        $.ajax({
            url: url,
            method: 'GET',
            headers: {
                'Authorization': `Bearer ${nickname}`
            },
            success: function(response) {
                console.log('ì„œë²„ ì‘ë‹µ:', response);
                // ìœ ì € ì¡´ì¬ í™•ì¸ ì™„ë£Œ - success í˜ì´ì§€ë¡œ ì´ë™
                if (response.success && response.userExists) redirectSuccess(response.paymentData, nickname);
                else alert('ì‚¬ìš©ì ê²€ì¦ ì‹¤íŒ¨: ' + response.message);
            },
            error: function(xhr, status, error) {
                console.error('ì„œë²„ í†µì‹  ì‹¤íŒ¨:', xhr.responseText);

                // 401 Unauthorized ì²˜ë¦¬
                if (xhr.status === 401) alert('ì¸ì¦ ì‹¤íŒ¨: Authorization í—¤ë”ê°€ ìœ íš¨í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                else alert('ì„œë²„ í†µì‹  ì‹¤íŒ¨: ' + error);
            }
        });
    }

    // íŒŒë² ì— ê²°ì œ ì •ë³´ ì €ì¥í•˜ëŠ” í•¨ìˆ˜
    async function savePaymentToFirebase(paymentData, nickname) {
        if (!firebaseInitialized || !db) return console.warn('âš ï¸ Firebaseê°€ ì´ˆê¸°í™”ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');

        try {
            const userId = sessionStorage.getItem('userUid'); // í˜„ì¬ ë¡œê·¸ì¸í•œ ì‚¬ìš©ì UID
            const userName = decodeURIComponent(nickname);

            const now = new Date();
            const formattedTimestamp = now.toISOString().replace(/T/, '_').replace(/:/g, '-').replace(/\..+/, '') + '.' + now.getMilliseconds();

            // user_Payment ì»¬ë ‰ì…˜ì— ì €ì¥í•  ë°ì´í„°
            const paymentDocument = {
                userId: userId,
                userName: userName,
                orderId: paymentData.orderId,
                amount: parseInt(paymentData.amount),
                orderName: paymentData.orderName,
                paymentMethod: paymentData.method,
                paymentKey: paymentData.paymentKey,
                creditAmount: parseInt(paymentData.creditAmount),
                paymentStatus: 'completed',
                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                timestamp: now.toISOString()
            };

            console.log('ğŸ’¾ íŒŒì´ì–´ë² ì´ìŠ¤ì— ì €ì¥í•  ê²°ì œ ë°ì´í„°:', paymentDocument);

            // user_Payment ì»¬ë ‰ì…˜ì— ë¬¸ì„œ ì¶”ê°€
            // ë¬¸ì„œ ì°¸ì¡°ë¥¼ ë¨¼ì € ìƒì„±
            const docRef = db.collection('user_Payment').doc(formattedTimestamp);
            // set() í˜¸ì¶œ (ë°˜í™˜ê°’ ì—†ìŒ)
            await docRef.set(paymentDocument);

            console.log('âœ… íŒŒì´ì–´ë² ì´ìŠ¤ ê²°ì œ ì •ë³´ ì €ì¥ ì„±ê³µ! ë¬¸ì„œ ID:', docRef.id);

            // ê²°ì œëŠ” ì„±ê³µí–ˆì§€ë§Œ ì €ì¥ ì‹¤íŒ¨ ì‹œ ì—ëŸ¬ ë¡œê·¸ë§Œ ë‚¨ê¸°ê³  ì§„í–‰
        } catch (error) { console.error('âŒ íŒŒì´ì–´ë² ì´ìŠ¤ ê²°ì œ ì •ë³´ ì €ì¥ ì‹¤íŒ¨:', error);}
    }

    // HTTP ë°©ì‹ìœ¼ë¡œ success í˜ì´ì§€ì— ë°ì´í„° ì „ë‹¬í•˜ëŠ” í•¨ìˆ˜ë„ ì „ì—­ìœ¼ë¡œ ì •ì˜
    // redirectToSuccessWithHttpData í•¨ìˆ˜ë¥¼ ì´ê²ƒìœ¼ë¡œ êµì²´
    function redirectSuccess(paymentData, nickname) {
        console.log('ğŸ’¾ sessionStorageì— ê²°ì œ ì •ë³´ ì €ì¥');
        console.log('ğŸ“Š ì›ë³¸ paymentData:', paymentData);
        console.log('ğŸ‘¤ ì›ë³¸ nickname:', nickname);

        // sessionStorageì— ê²°ì œ ì •ë³´ ì €ì¥ (ë¸Œë¼ìš°ì € íƒ­ ì¢…ë£Œì‹œê¹Œì§€ ìœ ì§€)
        const paymentInfo = {
            nickname: decodeURIComponent(nickname),
            orderId: paymentData.orderId || 'N/A',
            amount: paymentData.amount || '0',
            orderName: paymentData.orderName || 'N/A',
            method: paymentData.method || 'N/A',
            creditAmount: paymentData.creditAmount || '0',
            timestamp: Date.now() // íƒ€ì„ìŠ¤íƒ¬í”„ ì¶”ê°€
        };

        console.log('ğŸ’¿ ì €ì¥í•  paymentInfo:', paymentInfo);

        // sessionStorageì— ì €ì¥
        sessionStorage.setItem('successPageData', JSON.stringify(paymentInfo));

        // ì €ì¥ í™•ì¸
        const savedData = sessionStorage.getItem('successPageData');
        console.log('âœ… ì €ì¥ í™•ì¸:', savedData);

        // URLì—ëŠ” ë¯¼ê°ì •ë³´ ì—†ì´ ë‹¨ìˆœ ì´ë™
        window.location.href = '/success';
    }

    // êµ¬ë§¤í•˜ê¸° ë²„íŠ¼ ëˆ„ë¥´ë©´ ì‹¤í–‰ë¨
    function requestpay() {
        const productName = `${selectedOption.querySelector('.credit-amount').textContent}`;
        const amount = parseInt(selectedOption.getAttribute('data-price'));

        IMP.request_pay({
            pg: selectedPG,
            // pg: 'nice_v2',
            // pg: 'tosspay',
            // pg: 'payco',
            pay_method: 'card',
            merchant_uid: `payment-${new Date().getTime()}`,
            name: productName,
            amount: amount,
            buyer_email: currentUserEmail,
            buyer_name: currentUserName,
        }, function (rsp) {
            console.log('=== ì•„ì„í¬íŠ¸ ì‘ë‹µ ì „ì²´ ===');
            console.log('í¬íŠ¸ì‚¬ ê±°ë˜ë²ˆí˜¸:', rsp.imp_uid);
            console.log('ê³ ê°ì‚¬ê±°ë˜ë²ˆí˜¸:', rsp.merchant_uid);
            console.log('ì„±ê³µì—¬ë¶€:', rsp.success);
            console.log('ì‹¤íŒ¨ì—¬ë¶€:', rsp.error_code);
            // pgì‚¬ ë§ˆë‹¤ ì„±ê³µì‹¤íŒ¨ ì—¬ë¶€ ë³´ë‚´ëŠ”ê²Œ ë‹¤ë¥´ê¸°ë„ í•˜ê³  í…ŒìŠ¤íŠ¸ ê²°ì œëŠ” ì•ˆë³´ë‚´ëŠ” ê²½ìš°ë„ ìˆìŒ.(ë‚˜ì´ìŠ¤ê°€ê·¸ëŸ¼. ì•ˆë³´ë‚´ì„œ undifinedì„)
            console.log('rsp ì—¬ë¶€:', rsp);
            console.log('========================');

            if(rsp.error_code) {
                console.log('ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì²˜ë¦¬');
                console.log('ì‹¤íŒ¨ ì½”ë“œì™€ ë©”ì‹œì§€', rsp.error_code, rsp.error_msg);
            } else if (rsp.success === true && rsp.imp_uid && rsp.merchant_uid) {
                console.log('ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ (imp_uidì™€ merchant_uid ì¡´ì¬)');
                sessionStorage.setItem('orderId', rsp.merchant_uid);
                sessionStorage.setItem('amount', amount.toString());
                sessionStorage.setItem('orderName', productName);
                sessionStorage.setItem('method', rsp.pay_method || 'ì¹´ë“œ');
                sessionStorage.setItem('paymentKey', rsp.imp_uid);
                sessionStorage.setItem('creditAmount', selectedOption.getAttribute('data-credit'));
                sessionStorage.setItem('userId', document.getElementById('user-id').textContent);
                sendToServer(rsp);
            } else if ((rsp.success === undefined || rsp.success === null) && rsp.imp_uid && rsp.merchant_uid) {
            // í˜„ì¬ successë„, error_codeë„ undefinedì´ê¸°ì— ë‹¨ìˆœí•˜ê²Œ imp_uidì™€ merchant_uid ì¡´ì¬ë§Œìœ¼ë¡œ ì„±ê³µ íŒë‹¨
                console.log('ê²°ì œ ì™„ë£Œ ì²˜ë¦¬ (imp_uidì™€ merchant_uid ì¡´ì¬)');
                sessionStorage.setItem('orderId', rsp.merchant_uid);
                sessionStorage.setItem('amount', amount.toString());
                sessionStorage.setItem('orderName', productName);
                sessionStorage.setItem('method', rsp.pay_method || 'ì¹´ë“œ');
                sessionStorage.setItem('paymentKey', rsp.imp_uid);
                sessionStorage.setItem('creditAmount', selectedOption.getAttribute('data-credit'));
                sessionStorage.setItem('userId', document.getElementById('user-id').textContent);
                sendToServer(rsp);
            } else if (!rsp.success) {
            // ì¹´ì¹´ì˜¤í˜ì´ìš©. ë‚˜ì´ìŠ¤í˜ì´í• ê±°ë©´ ì£¼ì„ì²˜ë¦¬í• ê²ƒ
            const iframes = document.querySelectorAll("iframe");
            iframes.forEach(iframe => iframe.remove());
            console.log('ê²°ì œ ì‹¤íŒ¨/ì·¨ì†Œ ì²˜ë¦¬');
            console.log('ì‹¤íŒ¨ ì½”ë“œì™€ ë©”ì‹œì§€', rsp.error_code, rsp.error_msg);
            selectedPG = null;
            }
        });
    }

    function ButtonClick(event) {
        const button = event.currentTarget;
        const option = button.closest('.credit-option');
        if (!option) return;

        // ì„ íƒ í‘œì‹œ ì²˜ë¦¬
        document.querySelectorAll('.credit-option').forEach(opt => opt.classList.remove('selected'));
        option.classList.add('selected');
        selectedOption = option;

        // ìƒí’ˆ ì •ë³´ í‘œì‹œ
        const productName = option.querySelector('.credit-amount').textContent;
        const price = option.getAttribute('data-price');
        document.querySelector('.pay-product').textContent = `${productName}`;
        document.querySelector('.pay-amount').textContent = `${Number(price).toLocaleString()}ì›`;

        // ê²°ì œìˆ˜ë‹¨ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
        document.getElementById('pg-modal').classList.remove('hidden');
    }

    function handlePGSelect(pgName) {
        selectedPG = pgName; // ì„ íƒëœ PGì‚¬ ì €ì¥
        document.getElementById('pg-modal').classList.add('hidden'); // ëª¨ë‹¬ ë‹«ê¸°
        requestpay(); // ê²°ì œ í•¨ìˆ˜ ì‹¤í–‰
    }

    // í¬ë ˆë”§ ì˜µì…˜ í´ë¦­ ì²˜ë¦¬
    document.querySelectorAll('.credit-option').forEach(option => {
        option.addEventListener('click', function(event) {
            // ë²„íŠ¼ í´ë¦­ì´ë©´ ì´ ì´ë²¤íŠ¸ì—ì„œëŠ” ì•„ë¬´ ê²ƒë„ í•˜ì§€ ì•ŠìŒ (ë²„íŠ¼ì— ë”°ë¡œ requestpay() ìˆìŒ)
            if (event.target.classList.contains('purchase-button')) return;

            // ì„ íƒ í‘œì‹œ ì²˜ë¦¬. ë‹¤ë¥¸ ì„¹ë ‰ í´ë˜ìŠ¤ëª… ì—†ì• ëŠ”ê±°.
            document.querySelectorAll('.credit-option').forEach(opt => opt.classList.remove('selected'));
            this.classList.add('selected');
            selectedOption = this;

            // ìƒí’ˆ ì •ë³´ í‘œì‹œ
            const productName = this.querySelector('.credit-amount').textContent;
            const price = this.getAttribute('data-price');
            document.querySelector('.pay-product').textContent = `${productName}`;
            document.querySelector('.pay-amount').textContent = `${Number(price).toLocaleString()}ì›`;

            // ê²°ì œìˆ˜ë‹¨ ì„ íƒ ëª¨ë‹¬ í‘œì‹œ
            document.getElementById('pg-modal').classList.remove('hidden');
        });
    });
</script>
</body>
</html>